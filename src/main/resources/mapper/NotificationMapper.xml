<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linkme.backend.mapper.NotificationMapper">

    <resultMap id="NotificationMap" type="com.linkme.backend.entity.Notification">
        <id column="notification_id" property="notificationId"/>
        <result column="user_id" property="userId"/>
        <result column="type" property="type"/>
        <result column="actor_id" property="actorId"/>
        <result column="related_id" property="relatedId"/>
        <result column="related_type" property="relatedType"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="created_at" property="createdAt"/>
        <result column="is_read" property="isRead"/>
    </resultMap>

    <!-- 查询指定用户的通知列表（支持是否已读筛选、分页） -->
    <select id="selectByUserId" resultMap="NotificationMap">
        SELECT * FROM notification
        WHERE user_id = #{userId}
        <if test="isRead != null">
            AND is_read = #{isRead}
        </if>
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 查询指定操作者的通知列表 -->
    <select id="selectByActorId" resultMap="NotificationMap">
        SELECT * FROM notification
        WHERE actor_id = #{actorId}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 查询单条通知 -->
    <select id="selectById" resultMap="NotificationMap">
        SELECT * FROM notification WHERE notification_id = #{notificationId}
    </select>

    <!-- 插入新通知 -->
    <insert id="insert" parameterType="com.linkme.backend.entity.Notification" useGeneratedKeys="true" keyProperty="notificationId">
        INSERT INTO notification (
            user_id, type, actor_id, related_id, related_type, title, content, created_at, is_read
        ) VALUES (
            #{userId}, #{type}, #{actorId}, #{relatedId}, #{relatedType}, #{title}, #{content}, #{createdAt}, #{isRead}
        )
    </insert>

    <!-- 更新通知（如标记已读） -->
    <update id="update" parameterType="com.linkme.backend.entity.Notification">
        UPDATE notification
        SET
            user_id = #{userId},
            type = #{type},
            actor_id = #{actorId},
            related_id = #{relatedId},
            related_type = #{relatedType},
            title = #{title},
            content = #{content},
            created_at = #{createdAt},
            is_read = #{isRead}
        WHERE notification_id = #{notificationId}
    </update>

    <!-- 删除通知 -->
    <delete id="deleteById">
        DELETE FROM notification WHERE notification_id = #{notificationId}
    </delete>

    <!-- 统计未读通知数量 -->
    <select id="countUnreadByUserId" resultType="int">
        SELECT COUNT(*) FROM notification WHERE user_id = #{userId} AND is_read = 0
    </select>

</mapper>
